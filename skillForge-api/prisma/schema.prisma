
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
}

// --- Enums ---

enum UserRole {
  user
  admin
}

enum SubscriptionPlanType {
  free
  starter
  professional
  enterprise
}

enum PlanBadge {
  Free
  Starter
  Professional
  Enterprise
}

enum ProfileVisibility {
  public
  private
}

// --- Models ---

model Skill {
  id              String    @id @default(uuid()) @db.Uuid
  providerId      String    @map("provider_id") @db.Uuid
  title           String    @db.VarChar(255)
  description     String    @db.Text
  category        String    @db.VarChar(100)
  level           String    @db.VarChar(50) // Beginner, Intermediate, Advanced, Expert
  durationHours   Int       @map("duration_hours") // Structured: 1, 2, 3, 4, 5, etc.
  creditsPerHour  Int       @map("credits_per_hour")
  tags            String[]  @default([])
  imageUrl        String?   @map("image_url") @db.Text
  status          String    @default("pending-verification") // pending-verification, verified, approved, rejected
  
  // Verification System
  verificationStatus    String?   @default("not_started") @map("verification_status") // not_started, in_progress, passed, failed
  mcqScore              Int?      @default(0) @map("mcq_score")
  mcqTotalQuestions     Int?      @default(0) @map("mcq_total_questions")
  mcqPassingScore       Int?      @default(70) @map("mcq_passing_score") // Percentage
  verifiedAt            DateTime? @map("verified_at") @db.Timestamptz(6)
  rejectionReason       String?   @map("rejection_reason") @db.Text
  
  // Stats
  totalSessions   Int       @default(0) @map("total_sessions")
  rating          Decimal?  @default(0) @db.Decimal(3, 2)
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isDeleted       Boolean   @default(false) @map("is_deleted")

  // Relations
  provider        User      @relation(fields: [providerId], references: [id])
  verificationAttempts SkillVerificationAttempt[]

  @@index([providerId])
  @@index([category])
  @@index([status])
  @@index([verificationStatus])
  @@map("skills")
}

// Skill Template (Admin-managed)
model SkillTemplate {
  id              String    @id @default(uuid()) @db.Uuid
  title           String    @db.VarChar(255)
  category        String    @db.VarChar(100)
  description     String    @db.Text
  creditsMin      Int       @map("credits_min")
  creditsMax      Int       @map("credits_max")
  mcqCount        Int       @map("mcq_count")
  passRange       Int       @default(70) @map("pass_range") // Percentage
  levels          String[]  @default([]) // ["Beginner", "Intermediate", "Advanced"]
  tags            String[]  @default([])
  status          String    @default("Active") // Active, Inactive
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  isActive        Boolean   @default(true) @map("is_active")

  // Relations
  questions       TemplateQuestion[]

  @@index([category])
  @@index([status])
  @@index([isActive])
  @@map("skill_templates")
}

// MCQ Questions for Skill Templates
model TemplateQuestion {
  id              String          @id @default(uuid()) @db.Uuid
  templateId      String          @map("template_id") @db.Uuid
  level           String          @db.VarChar(50) // Beginner, Intermediate, Advanced
  question        String          @db.Text
  options         Json            // Array of options: ["Option A", "Option B", "Option C", "Option D"]
  correctAnswer   Int             @map("correct_answer") // Index of correct option (0-3)
  explanation     String?         @db.Text // Optional explanation for the answer
  
  // Metadata
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  template        SkillTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([level])
  @@index([isActive])
  @@map("template_questions")
}

// Keep original SkillQuestion for backward compatibility
model SkillQuestion {
  id              String    @id @default(uuid()) @db.Uuid
  category        String    @db.VarChar(100)
  level           String    @db.VarChar(50) // Beginner, Intermediate, Advanced, Expert
  question        String    @db.Text
  options         Json      // Array of options: ["Option A", "Option B", "Option C", "Option D"]
  correctAnswer   Int       @map("correct_answer") // Index of correct option (0-3)
  difficulty      String    @default("medium") // easy, medium, hard
  tags            String[]  @default([])
  
  // Metadata
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([category])
  @@index([level])
  @@index([difficulty])
  @@index([isActive])
  @@map("skill_questions")
}

// Track verification attempts
model SkillVerificationAttempt {
  id              String    @id @default(uuid()) @db.Uuid
  skillId         String    @map("skill_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  questionsAsked  Json      @map("questions_asked") // Array of question IDs
  userAnswers     Json      @map("user_answers") // Array of user's answers
  score           Int       // Percentage score
  passed          Boolean   @default(false)
  timeTaken       Int?      @map("time_taken") // Seconds
  
  // Metadata
  attemptedAt     DateTime  @default(now()) @map("attempted_at") @db.Timestamptz(6)

  // Relations
  skill           Skill     @relation(fields: [skillId], references: [id])

  @@index([skillId])
  @@index([userId])
  @@index([attemptedAt])
  @@map("skill_verification_attempts")
}

model User {
  id                      String           @id @default(uuid()) @db.Uuid
  name                    String           @db.VarChar(255)
  email                   String           @unique @db.VarChar(255)
  passwordHash            String           @map("password_hash") @db.VarChar(255)
  avatarUrl               String?          @map("avatar_url") @db.Text
  bio                     String?          @db.Text
  location                String?          @db.VarChar(255)
  role                    UserRole         @default(user)

  // Credit System
  credits                 Int              @default(0)
  earnedCredits           Int              @default(0) @map("earned_credits")
  bonusCredits            Int              @default(0) @map("bonus_credits")
  purchasedCredits        Int              @default(0) @map("purchased_credits")
  walletBalance           Decimal          @default(0) @map("wallet_balance") @db.Decimal(10, 2)

  // Profile Data
  skillsOffered           String[]         @default([]) @map("skills_offered")
  skillsLearning          String[]         @default([]) @map("skills_learning")
  rating                  Decimal?         @default(0) @db.Decimal(3, 2)
  reviewCount             Int              @default(0) @map("review_count")
  totalSessionsCompleted  Int              @default(0) @map("total_sessions_completed")
  memberSince             DateTime         @default(now()) @map("member_since") @db.Timestamptz(6)

  // Verification Status (JSONB) - Updated for Email-Only Verification
  verification            Json             @default("{\"email_verified\":false,\"email_verified_at\":null,\"bank_details\":{\"account_number\":null,\"ifsc_code\":null,\"account_holder_name\":null,\"bank_name\":null,\"upi_id\":null,\"verified\":false,\"verified_at\":null,\"verification_method\":null}}")

  // Anti-Fraud Tracking (JSONB) - Updated to remove device_fingerprint
  antiFraud               Json             @default("{\"registration_ip\":null,\"last_login_ip\":null,\"account_age_days\":0,\"suspicious_activity_flags\":[],\"last_redemption_date\":null,\"redemption_count\":0,\"risk_score\":0,\"flagged_for_review\":false}") @map("anti_fraud")

  // Subscription Info
  subscriptionPlan        SubscriptionPlanType @default(free) @map("subscription_plan")
  subscriptionValidUntil  DateTime?        @map("subscription_valid_until") @db.Timestamptz(6)
  subscriptionAutoRenew   Boolean          @default(false) @map("subscription_auto_renew")
  subscriptionStartedAt   DateTime?        @map("subscription_started_at") @db.Timestamptz(6)

  // Admin Permissions (JSONB, nullable - only for admin role)
  adminPermissions        Json?            @map("admin_permissions")

  // Settings (JSONB) - Updated to remove SMS/Phone preferences
  settings                Json             @default("{\"marketing_emails\":true,\"notification_preferences\":{\"email\":true,\"push\":true,\"booking_notifications\":true,\"message_notifications\":true,\"credit_notifications\":true,\"community_notifications\":true,\"project_notifications\":true},\"privacy_settings\":{\"profile_visibility\":\"public\",\"show_location\":true,\"show_email\":false},\"language\":\"en\",\"timezone\":\"UTC\"}")

  // Metadata
  createdAt               DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLogin               DateTime?        @map("last_login") @db.Timestamptz(6)
  lastActive              DateTime?        @map("last_active") @db.Timestamptz(6)
  isActive                Boolean          @default(true) @map("is_active")
  isDeleted               Boolean          @default(false) @map("is_deleted")
  deletedAt               DateTime?        @map("deleted_at") @db.Timestamptz(6)

  // Relations
  passwordResetTokens     PasswordResetToken[]
  skills Skill[]


  
  // NOTE: OTPToken relation removed as OTP is stored in Redis.

  @@index([email])
  @@index([subscriptionPlan])
  @@index([createdAt])
  @@index([role])
  @@index([isActive])
  @@index([isDeleted])
  @@map("users")
}

model PasswordResetToken {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  token         String    @unique @db.VarChar(255)
  isUsed        Boolean   @default(false) @map("is_used")
  ipAddress     String?   @map("ip_address") @db.VarChar(45)
  userAgent     String?   @map("user_agent") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz(6)
  usedAt        DateTime? @map("used_at") @db.Timestamptz(6)

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// --- Subscription Management Models ---

model SubscriptionPlanModel {
  id                String      @id @default(uuid()) @db.Uuid
  name              String      @unique @db.VarChar(100)
  price             Decimal     @db.Decimal(10, 2)
  projectPosts      Int?        @map("project_posts") // null = unlimited
  communityPosts    Int?        @map("community_posts") // null = unlimited
  badge             PlanBadge
  color             String      @default("blue") @db.VarChar(50)
  isActive          Boolean     @default(true) @map("is_active")
  
  // Features stored as JSONB array: [{id: string, name: string}]
  features          Json        @default("[]")
  
  // Metadata
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([name])
  @@index([badge])
  @@index([isActive])
  @@index([price])
  @@map("subscription_plans")
}